{"version":3,"names":["BasePlugin","nanoid","Provider","RequestClient","Socket","emitSocketProgress","getSocketHost","settle","EventTracker","ProgressTimeout","RateLimitedQueue","internalRateLimitedQueue","NetworkError","isNetworkError","packageJson","locale","buildResponseError","xhr","err","error","Error","Object","assign","data","request","setTypeInBlob","file","dataWithUpdatedType","slice","size","meta","type","XHRUpload","constructor","uppy","opts","getOptions","Client","remote","providerOptions","provider","client","allowedMetaFields","Array","isArray","keys","res","post","url","body","protocol","endpoint","fieldname","fieldName","metadata","fromEntries","map","name","httpMethod","method","useFormData","formData","headers","token","id","title","defaultLocale","defaultOptions","bundle","responseUrlFieldName","timeout","limit","withCredentials","responseType","getResponseData","responseText","parsedResponse","JSON","parse","log","getResponseError","_","response","validateStatus","status","i18nInit","handleUpload","bind","requests","undefined","uploaderEvents","create","wrapPromiseFunction","priority","overrides","getState","xhrUpload","addMetadata","forEach","item","append","createFormDataUpload","formPost","FormData","createBundledUpload","files","options","upload","current","total","Promise","resolve","reject","emit","XMLHttpRequest","queuedRequest","timer","i18n","seconds","Math","ceil","addEventListener","ev","loaded","progress","lengthComputable","uploader","bytesUploaded","bytesTotal","done","remove","uploadURL","uploadResp","open","toUpperCase","run","currentOpts","header","setRequestHeader","send","abort","onFileRemove","onCancelAll","reason","uploadRemote","serverToken","connectToServerSocket","setFileState","getFile","host","companionUrl","socket","createSocket","target","on","progressData","close","errData","resp","message","cause","isPaused","onRetryRequest","onRetry","onRetryAll","catch","uploadBundle","optsFromState","emitError","uploadFiles","promises","i","parseInt","length","isRemote","fileID","cb","targetFileID","eventHandler","fileIDs","isSomeFileRemote","some","TypeError","then","install","capabilities","setState","individualCancellation","addUploader","uninstall","removeUploader","VERSION","version"],"sources":["index.js"],"sourcesContent":["import BasePlugin from '@uppy/core/lib/BasePlugin.js'\nimport { nanoid } from 'nanoid/non-secure'\nimport { Provider, RequestClient, Socket } from '@uppy/companion-client'\nimport emitSocketProgress from '@uppy/utils/lib/emitSocketProgress'\nimport getSocketHost from '@uppy/utils/lib/getSocketHost'\nimport settle from '@uppy/utils/lib/settle'\nimport EventTracker from '@uppy/utils/lib/EventTracker'\nimport ProgressTimeout from '@uppy/utils/lib/ProgressTimeout'\nimport { RateLimitedQueue, internalRateLimitedQueue } from '@uppy/utils/lib/RateLimitedQueue'\nimport NetworkError from '@uppy/utils/lib/NetworkError'\nimport isNetworkError from '@uppy/utils/lib/isNetworkError'\n\nimport packageJson from '../package.json'\nimport locale from './locale.js'\n\nfunction buildResponseError (xhr, err) {\n  let error = err\n  // No error message\n  if (!error) error = new Error('Upload error')\n  // Got an error message string\n  if (typeof error === 'string') error = new Error(error)\n  // Got something else\n  if (!(error instanceof Error)) {\n    error = Object.assign(new Error('Upload error'), { data: error })\n  }\n\n  if (isNetworkError(xhr)) {\n    error = new NetworkError(error, xhr)\n    return error\n  }\n\n  error.request = xhr\n  return error\n}\n\n/**\n * Set `data.type` in the blob to `file.meta.type`,\n * because we might have detected a more accurate file type in Uppy\n * https://stackoverflow.com/a/50875615\n *\n * @param {object} file File object with `data`, `size` and `meta` properties\n * @returns {object} blob updated with the new `type` set from `file.meta.type`\n */\nfunction setTypeInBlob (file) {\n  const dataWithUpdatedType = file.data.slice(0, file.data.size, file.meta.type)\n  return dataWithUpdatedType\n}\n\nexport default class XHRUpload extends BasePlugin {\n  // eslint-disable-next-line global-require\n  static VERSION = packageJson.version\n\n  #queueRequestSocketToken\n\n  constructor (uppy, opts) {\n    super(uppy, opts)\n    this.type = 'uploader'\n    this.id = this.opts.id || 'XHRUpload'\n    this.title = 'XHRUpload'\n\n    this.defaultLocale = locale\n\n    // Default options\n    const defaultOptions = {\n      formData: true,\n      fieldName: opts.bundle ? 'files[]' : 'file',\n      method: 'post',\n      allowedMetaFields: null,\n      responseUrlFieldName: 'url',\n      bundle: false,\n      headers: {},\n      timeout: 30 * 1000,\n      limit: 5,\n      withCredentials: false,\n      responseType: '',\n      /**\n       * @param {string} responseText the response body string\n       */\n      getResponseData (responseText) {\n        let parsedResponse = {}\n        try {\n          parsedResponse = JSON.parse(responseText)\n        } catch (err) {\n          uppy.log(err)\n        }\n\n        return parsedResponse\n      },\n      /**\n       *\n       * @param {string} _ the response body string\n       * @param {XMLHttpRequest | respObj} response the response object (XHR or similar)\n       */\n      getResponseError (_, response) {\n        let error = new Error('Upload error')\n\n        if (isNetworkError(response)) {\n          error = new NetworkError(error, response)\n        }\n\n        return error\n      },\n      /**\n       * Check if the response from the upload endpoint indicates that the upload was successful.\n       *\n       * @param {number} status the response status code\n       */\n      validateStatus (status) {\n        return status >= 200 && status < 300\n      },\n    }\n\n    this.opts = { ...defaultOptions, ...opts }\n    this.i18nInit()\n\n    this.handleUpload = this.handleUpload.bind(this)\n\n    // Simultaneous upload limiting is shared across all uploads with this plugin.\n    if (internalRateLimitedQueue in this.opts) {\n      this.requests = this.opts[internalRateLimitedQueue]\n    } else {\n      this.requests = new RateLimitedQueue(this.opts.limit)\n    }\n\n    if (this.opts.bundle && !this.opts.formData) {\n      throw new Error('`opts.formData` must be true when `opts.bundle` is enabled.')\n    }\n\n    if (opts?.allowedMetaFields === undefined && 'metaFields' in this.opts) {\n      throw new Error('The `metaFields` option has been renamed to `allowedMetaFields`.')\n    }\n\n    this.uploaderEvents = Object.create(null)\n    this.#queueRequestSocketToken = this.requests.wrapPromiseFunction(this.#requestSocketToken, { priority: -1 })\n  }\n\n  getOptions (file) {\n    const overrides = this.uppy.getState().xhrUpload\n    const { headers } = this.opts\n\n    const opts = {\n      ...this.opts,\n      ...(overrides || {}),\n      ...(file.xhrUpload || {}),\n      headers: {},\n    }\n    // Support for `headers` as a function, only in the XHRUpload settings.\n    // Options set by other plugins in Uppy state or on the files themselves are still merged in afterward.\n    //\n    // ```js\n    // headers: (file) => ({ expires: file.meta.expires })\n    // ```\n    if (typeof headers === 'function') {\n      opts.headers = headers(file)\n    } else {\n      Object.assign(opts.headers, this.opts.headers)\n    }\n\n    if (overrides) {\n      Object.assign(opts.headers, overrides.headers)\n    }\n    if (file.xhrUpload) {\n      Object.assign(opts.headers, file.xhrUpload.headers)\n    }\n\n    return opts\n  }\n\n  // eslint-disable-next-line class-methods-use-this\n  addMetadata (formData, meta, opts) {\n    const allowedMetaFields = Array.isArray(opts.allowedMetaFields)\n      ? opts.allowedMetaFields\n      : Object.keys(meta) // Send along all fields by default.\n\n    allowedMetaFields.forEach((item) => {\n      formData.append(item, meta[item])\n    })\n  }\n\n  createFormDataUpload (file, opts) {\n    const formPost = new FormData()\n\n    this.addMetadata(formPost, file.meta, opts)\n\n    const dataWithUpdatedType = setTypeInBlob(file)\n\n    if (file.name) {\n      formPost.append(opts.fieldName, dataWithUpdatedType, file.meta.name)\n    } else {\n      formPost.append(opts.fieldName, dataWithUpdatedType)\n    }\n\n    return formPost\n  }\n\n  createBundledUpload (files, opts) {\n    const formPost = new FormData()\n\n    const { meta } = this.uppy.getState()\n    this.addMetadata(formPost, meta, opts)\n\n    files.forEach((file) => {\n      const options = this.getOptions(file)\n\n      const dataWithUpdatedType = setTypeInBlob(file)\n\n      if (file.name) {\n        formPost.append(options.fieldName, dataWithUpdatedType, file.name)\n      } else {\n        formPost.append(options.fieldName, dataWithUpdatedType)\n      }\n    })\n\n    return formPost\n  }\n\n  upload (file, current, total) {\n    const opts = this.getOptions(file)\n\n    this.uppy.log(`uploading ${current} of ${total}`)\n    return new Promise((resolve, reject) => {\n      this.uppy.emit('upload-started', file)\n\n      const data = opts.formData\n        ? this.createFormDataUpload(file, opts)\n        : file.data\n\n      const xhr = new XMLHttpRequest()\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n      let queuedRequest\n\n      const timer = new ProgressTimeout(opts.timeout, () => {\n        const error = new Error(this.i18n('uploadStalled', { seconds: Math.ceil(opts.timeout / 1000) }))\n        this.uppy.emit('upload-stalled', error, [file])\n      })\n\n      const id = nanoid()\n\n      xhr.upload.addEventListener('loadstart', () => {\n        this.uppy.log(`[XHRUpload] ${id} started`)\n      })\n\n      xhr.upload.addEventListener('progress', (ev) => {\n        this.uppy.log(`[XHRUpload] ${id} progress: ${ev.loaded} / ${ev.total}`)\n        // Begin checking for timeouts when progress starts, instead of loading,\n        // to avoid timing out requests on browser concurrency queue\n        timer.progress()\n\n        if (ev.lengthComputable) {\n          this.uppy.emit('upload-progress', file, {\n            uploader: this,\n            bytesUploaded: ev.loaded,\n            bytesTotal: ev.total,\n          })\n        }\n      })\n\n      xhr.addEventListener('load', () => {\n        this.uppy.log(`[XHRUpload] ${id} finished`)\n        timer.done()\n        queuedRequest.done()\n        if (this.uploaderEvents[file.id]) {\n          this.uploaderEvents[file.id].remove()\n          this.uploaderEvents[file.id] = null\n        }\n\n        if (opts.validateStatus(xhr.status, xhr.responseText, xhr)) {\n          const body = opts.getResponseData(xhr.responseText, xhr)\n          const uploadURL = body[opts.responseUrlFieldName]\n\n          const uploadResp = {\n            status: xhr.status,\n            body,\n            uploadURL,\n          }\n\n          this.uppy.emit('upload-success', file, uploadResp)\n\n          if (uploadURL) {\n            this.uppy.log(`Download ${file.name} from ${uploadURL}`)\n          }\n\n          return resolve(file)\n        }\n        const body = opts.getResponseData(xhr.responseText, xhr)\n        const error = buildResponseError(xhr, opts.getResponseError(xhr.responseText, xhr))\n\n        const response = {\n          status: xhr.status,\n          body,\n        }\n\n        this.uppy.emit('upload-error', file, error, response)\n        return reject(error)\n      })\n\n      xhr.addEventListener('error', () => {\n        this.uppy.log(`[XHRUpload] ${id} errored`)\n        timer.done()\n        queuedRequest.done()\n        if (this.uploaderEvents[file.id]) {\n          this.uploaderEvents[file.id].remove()\n          this.uploaderEvents[file.id] = null\n        }\n\n        const error = buildResponseError(xhr, opts.getResponseError(xhr.responseText, xhr))\n        this.uppy.emit('upload-error', file, error)\n        return reject(error)\n      })\n\n      xhr.open(opts.method.toUpperCase(), opts.endpoint, true)\n      // IE10 does not allow setting `withCredentials` and `responseType`\n      // before `open()` is called.\n      xhr.withCredentials = opts.withCredentials\n      if (opts.responseType !== '') {\n        xhr.responseType = opts.responseType\n      }\n\n      queuedRequest = this.requests.run(() => {\n        this.uppy.emit('upload-started', file)\n\n        // When using an authentication system like JWT, the bearer token goes as a header. This\n        // header needs to be fresh each time the token is refreshed so computing and setting the\n        // headers just before the upload starts enables this kind of authentication to work properly.\n        // Otherwise, half-way through the list of uploads the token could be stale and the upload would fail.\n        const currentOpts = this.getOptions(file)\n\n        Object.keys(currentOpts.headers).forEach((header) => {\n          xhr.setRequestHeader(header, currentOpts.headers[header])\n        })\n\n        xhr.send(data)\n\n        return () => {\n          timer.done()\n          xhr.abort()\n        }\n      })\n\n      this.onFileRemove(file.id, () => {\n        queuedRequest.abort()\n        reject(new Error('File removed'))\n      })\n\n      this.onCancelAll(file.id, ({ reason }) => {\n        if (reason === 'user') {\n          queuedRequest.abort()\n        }\n        reject(new Error('Upload cancelled'))\n      })\n    })\n  }\n\n  #requestSocketToken = async (file) => {\n    const opts = this.getOptions(file)\n    const Client = file.remote.providerOptions.provider ? Provider : RequestClient\n    const client = new Client(this.uppy, file.remote.providerOptions)\n    const allowedMetaFields = Array.isArray(opts.allowedMetaFields)\n      ? opts.allowedMetaFields\n      // Send along all fields by default.\n      : Object.keys(file.meta)\n    const res = await client.post(file.remote.url, {\n      ...file.remote.body,\n      protocol: 'multipart',\n      endpoint: opts.endpoint,\n      size: file.data.size,\n      fieldname: opts.fieldName,\n      metadata: Object.fromEntries(allowedMetaFields.map(name => [name, file.meta[name]])),\n      httpMethod: opts.method,\n      useFormData: opts.formData,\n      headers: opts.headers,\n    })\n    return res.token\n  }\n\n  // NOTE! Keep this duplicated code in sync with other plugins\n  // TODO we should probably abstract this into a common function\n  async uploadRemote (file) {\n    // TODO: we could rewrite this to use server-sent events instead of creating WebSockets.\n    try {\n      this.uppy.emit('upload-started', file)\n      if (file.serverToken) {\n        return await this.connectToServerSocket(file)\n      }\n      const serverToken = await this.#queueRequestSocketToken(file)\n\n      if (!this.uppy.getState().files[file.id]) return undefined\n\n      this.uppy.setFileState(file.id, { serverToken })\n      return await this.connectToServerSocket(this.uppy.getFile(file.id))\n    } catch (err) {\n      this.uppy.setFileState(file.id, { serverToken: undefined })\n      this.uppy.emit('upload-error', file, err)\n      throw err\n    }\n  }\n\n  async connectToServerSocket (file) {\n    return new Promise((resolve, reject) => {\n      const opts = this.getOptions(file)\n      const token = file.serverToken\n      const host = getSocketHost(file.remote.companionUrl)\n      let socket\n\n      const createSocket = () => {\n        if (socket != null) return\n\n        socket = new Socket({ target: `${host}/api/${token}` })\n\n        socket.on('progress', (progressData) => emitSocketProgress(this, progressData, file))\n\n        socket.on('success', (data) => {\n          const body = opts.getResponseData(data.response.responseText, data.response)\n          const uploadURL = body[opts.responseUrlFieldName]\n\n          const uploadResp = {\n            status: data.response.status,\n            body,\n            uploadURL,\n          }\n\n          this.uppy.emit('upload-success', file, uploadResp)\n          queuedRequest.done() // eslint-disable-line no-use-before-define\n          socket.close()\n          if (this.uploaderEvents[file.id]) {\n            this.uploaderEvents[file.id].remove()\n            this.uploaderEvents[file.id] = null\n          }\n          return resolve()\n        })\n\n        socket.on('error', (errData) => {\n          const resp = errData.response\n          const error = resp\n            ? opts.getResponseError(resp.responseText, resp)\n            : Object.assign(new Error(errData.error.message), { cause: errData.error })\n          this.uppy.emit('upload-error', file, error)\n          queuedRequest.done() // eslint-disable-line no-use-before-define\n          if (this.uploaderEvents[file.id]) {\n            this.uploaderEvents[file.id].remove()\n            this.uploaderEvents[file.id] = null\n          }\n          reject(error)\n        })\n      }\n      this.uploaderEvents[file.id] = new EventTracker(this.uppy)\n\n      let queuedRequest = this.requests.run(() => {\n        if (file.isPaused) {\n          socket?.send('pause', {})\n        } else {\n          createSocket()\n        }\n\n        return () => socket.close()\n      })\n\n      this.onFileRemove(file.id, () => {\n        socket?.send('cancel', {})\n        queuedRequest.abort()\n        resolve(`upload ${file.id} was removed`)\n      })\n\n      this.onCancelAll(file.id, ({ reason } = {}) => {\n        if (reason === 'user') {\n          socket?.send('cancel', {})\n          queuedRequest.abort()\n        }\n        resolve(`upload ${file.id} was canceled`)\n      })\n\n      const onRetryRequest = () => {\n        if (socket == null) {\n          queuedRequest.abort()\n        } else {\n          socket.send('pause', {})\n          queuedRequest.done()\n        }\n        queuedRequest = this.requests.run(() => {\n          if (!file.isPaused) {\n            if (socket == null) {\n              createSocket()\n            } else {\n              socket.send('resume', {})\n            }\n          }\n\n          return () => socket.close()\n        })\n      }\n      this.onRetry(file.id, onRetryRequest)\n      this.onRetryAll(file.id, onRetryRequest)\n    }).catch((err) => {\n      this.uppy.emit('upload-error', file, err)\n      return Promise.reject(err)\n    })\n  }\n\n  uploadBundle (files) {\n    return new Promise((resolve, reject) => {\n      const { endpoint } = this.opts\n      const { method } = this.opts\n\n      const optsFromState = this.uppy.getState().xhrUpload\n      const formData = this.createBundledUpload(files, {\n        ...this.opts,\n        ...(optsFromState || {}),\n      })\n\n      const xhr = new XMLHttpRequest()\n\n      const emitError = (error) => {\n        files.forEach((file) => {\n          this.uppy.emit('upload-error', file, error)\n        })\n      }\n\n      const timer = new ProgressTimeout(this.opts.timeout, () => {\n        const error = new Error(this.i18n('uploadStalled', { seconds: Math.ceil(this.opts.timeout / 1000) }))\n        this.uppy.emit('upload-stalled', error, files)\n      })\n\n      xhr.upload.addEventListener('loadstart', () => {\n        this.uppy.log('[XHRUpload] started uploading bundle')\n        timer.progress()\n      })\n\n      xhr.upload.addEventListener('progress', (ev) => {\n        timer.progress()\n\n        if (!ev.lengthComputable) return\n\n        files.forEach((file) => {\n          this.uppy.emit('upload-progress', file, {\n            uploader: this,\n            bytesUploaded: (ev.loaded / ev.total) * file.size,\n            bytesTotal: file.size,\n          })\n        })\n      })\n\n      xhr.addEventListener('load', (ev) => {\n        timer.done()\n\n        if (this.opts.validateStatus(ev.target.status, xhr.responseText, xhr)) {\n          const body = this.opts.getResponseData(xhr.responseText, xhr)\n          const uploadResp = {\n            status: ev.target.status,\n            body,\n          }\n          files.forEach((file) => {\n            this.uppy.emit('upload-success', file, uploadResp)\n          })\n          return resolve()\n        }\n\n        const error = this.opts.getResponseError(xhr.responseText, xhr) || new Error('Upload error')\n        error.request = xhr\n        emitError(error)\n        return reject(error)\n      })\n\n      xhr.addEventListener('error', () => {\n        timer.done()\n\n        const error = this.opts.getResponseError(xhr.responseText, xhr) || new Error('Upload error')\n        emitError(error)\n        return reject(error)\n      })\n\n      this.uppy.on('cancel-all', ({ reason } = {}) => {\n        if (reason !== 'user') return\n        timer.done()\n        xhr.abort()\n      })\n\n      xhr.open(method.toUpperCase(), endpoint, true)\n      // IE10 does not allow setting `withCredentials` and `responseType`\n      // before `open()` is called.\n      xhr.withCredentials = this.opts.withCredentials\n      if (this.opts.responseType !== '') {\n        xhr.responseType = this.opts.responseType\n      }\n\n      Object.keys(this.opts.headers).forEach((header) => {\n        xhr.setRequestHeader(header, this.opts.headers[header])\n      })\n\n      xhr.send(formData)\n\n      files.forEach((file) => {\n        this.uppy.emit('upload-started', file)\n      })\n    })\n  }\n\n  uploadFiles (files) {\n    const promises = files.map((file, i) => {\n      const current = parseInt(i, 10) + 1\n      const total = files.length\n\n      if (file.error) {\n        return Promise.reject(new Error(file.error))\n      } if (file.isRemote) {\n        return this.uploadRemote(file, current, total)\n      }\n      return this.upload(file, current, total)\n    })\n\n    return settle(promises)\n  }\n\n  onFileRemove (fileID, cb) {\n    this.uploaderEvents[fileID].on('file-removed', (file) => {\n      if (fileID === file.id) cb(file.id)\n    })\n  }\n\n  onRetry (fileID, cb) {\n    this.uploaderEvents[fileID].on('upload-retry', (targetFileID) => {\n      if (fileID === targetFileID) {\n        cb()\n      }\n    })\n  }\n\n  onRetryAll (fileID, cb) {\n    this.uploaderEvents[fileID].on('retry-all', () => {\n      if (!this.uppy.getFile(fileID)) return\n      cb()\n    })\n  }\n\n  onCancelAll (fileID, eventHandler) {\n    this.uploaderEvents[fileID].on('cancel-all', (...args) => {\n      if (!this.uppy.getFile(fileID)) return\n      eventHandler(...args)\n    })\n  }\n\n  handleUpload (fileIDs) {\n    if (fileIDs.length === 0) {\n      this.uppy.log('[XHRUpload] No files to upload!')\n      return Promise.resolve()\n    }\n\n    // No limit configured by the user, and no RateLimitedQueue passed in by a \"parent\" plugin\n    // (basically just AwsS3) using the internal symbol\n    if (this.opts.limit === 0 && !this.opts[internalRateLimitedQueue]) {\n      this.uppy.log(\n        '[XHRUpload] When uploading multiple files at once, consider setting the `limit` option (to `10` for example), to limit the number of concurrent uploads, which helps prevent memory and network issues: https://uppy.io/docs/xhr-upload/#limit-0',\n        'warning',\n      )\n    }\n\n    this.uppy.log('[XHRUpload] Uploading...')\n    const files = fileIDs.map((fileID) => this.uppy.getFile(fileID))\n\n    if (this.opts.bundle) {\n      // if bundle: true, we don’t support remote uploads\n      const isSomeFileRemote = files.some(file => file.isRemote)\n      if (isSomeFileRemote) {\n        throw new Error('Can’t upload remote files when the `bundle: true` option is set')\n      }\n\n      if (typeof this.opts.headers === 'function') {\n        throw new TypeError('`headers` may not be a function when the `bundle: true` option is set')\n      }\n\n      return this.uploadBundle(files)\n    }\n\n    return this.uploadFiles(files).then(() => null)\n  }\n\n  install () {\n    if (this.opts.bundle) {\n      const { capabilities } = this.uppy.getState()\n      this.uppy.setState({\n        capabilities: {\n          ...capabilities,\n          individualCancellation: false,\n        },\n      })\n    }\n\n    this.uppy.addUploader(this.handleUpload)\n  }\n\n  uninstall () {\n    if (this.opts.bundle) {\n      const { capabilities } = this.uppy.getState()\n      this.uppy.setState({\n        capabilities: {\n          ...capabilities,\n          individualCancellation: true,\n        },\n      })\n    }\n\n    this.uppy.removeUploader(this.handleUpload)\n  }\n}\n"],"mappings":"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"}